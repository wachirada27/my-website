<!doctype html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>Reports | CPE x Drive Safety</title>

<link rel="icon" href="../img/icon.png">
<link rel="stylesheet" href="../CSS/style.css">

<!-- Export Library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>
.report-box{
  margin-top:90px;
  background:white;
  padding:30px;
  border-radius:20px;
  box-shadow:0 20px 40px rgba(0,0,0,.1);
}

.filters{
  display:flex;
  gap:15px;
  margin-bottom:20px;
  flex-wrap:wrap;
}

.filters select,
.filters input{
  padding:10px;
  border-radius:10px;
  border:1px solid #ccc;
}

.btn{
  padding:10px 18px;
  border:none;
  border-radius:12px;
  cursor:pointer;
  font-weight:600;
}

.pdf{ background:#e53935; color:white; }
.excel{ background:#2e7d32; color:white; }

table{
  width:100%;
  border-collapse:collapse;
}

th, td{
  padding:12px;
  border-bottom:1px solid #eee;
  text-align:center;
}

th{
  background:#1b5e4b;
  color:white;
}
</style>
</head>

<body>
<div class="app">

<aside>
  <a href="index.html">Dashboard</a>
  <a href="map.html">GPS Tracking</a>
  <a href="drivers.html">Drivers</a>
  <a href="reports.html">Reports</a>
  <a href="settings.html">Settings</a>
</aside>

<header>
  <div class="logo">
    <img src="../img/icon.png">
    <span>CPE x Drive Safety</span>
  </div>
</header>

<main>
<div class="report-box">

<h1>รายงานการขับขี่รายบุคคล</h1>

<div class="filters">
  <select id="driverSelect">
    <option value="ทั้งหมด">ทั้งหมด</option>
    <option value="สายฝน">สายฝน</option>
    <option value="กิตติพงษ์">กิตติพงษ์</option>
    <option value="อารียา">อารียา</option>
    <option value="อ.ปัญญา">อ.ปัญญา</option>
  </select>

  <input type="date" id="reportDate">

  <button class="btn pdf" onclick="exportPDF()">Export PDF</button>
  <button class="btn excel" onclick="exportExcel()">Export Excel</button>
</div>

<table id="reportTable">
  <thead>
    <tr>
      <th>วันที่</th>
      <th>ชื่อผู้ขับ</th>
      <th>ทะเบียน</th>
      <th>เวลาขับ (ชม.)</th>
      <th>สถานะ</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

</div>
</main>
</div>

<script>

// ===== ข้อมูลตัวอย่าง =====
const reports = [
 {date:"2026-02-20", driver:"สายฝน", plate:"1กข-1001", time:2.5},
 {date:"2026-02-20", driver:"กิตติพงษ์", plate:"1กข-1003", time:4.2},
 {date:"2026-02-21", driver:"อารียา", plate:"1กข-1004", time:3.7},
 {date:"2026-02-21", driver:"อ.ปัญญา", plate:"1กข-1005", time:5.1}
];

// ===== สถานะ =====
function getStatus(time){
  if(time < 3) return "ปกติ";
  if(time < 4) return "ใกล้เกินกำหนด";
  return "เกินกำหนด";
}

// ===== โหลดตาราง =====
function loadTable(){
  const tbody = document.querySelector("#reportTable tbody");
  tbody.innerHTML = "";

  const selectedDriver = document.getElementById("driverSelect").value;
  const selectedDate = document.getElementById("reportDate").value;

  reports.forEach(r=>{

    if(selectedDriver !== "ทั้งหมด" && r.driver !== selectedDriver) return;
    if(selectedDate && r.date !== selectedDate) return;

    const row = `
      <tr>
        <td>${r.date}</td>
        <td>${r.driver}</td>
        <td>${r.plate}</td>
        <td>${r.time}</td>
        <td>${getStatus(r.time)}</td>
      </tr>
    `;
    tbody.innerHTML += row;
  });
}

document.getElementById("driverSelect").addEventListener("change", loadTable);
document.getElementById("reportDate").addEventListener("change", loadTable);

loadTable();


// ===== Export Excel =====
function exportExcel(){
  const table = document.getElementById("reportTable");
  const wb = XLSX.utils.table_to_book(table, {sheet:"Report"});
  XLSX.writeFile(wb, "Driving_Report.xlsx");
}


// ===== Export PDF =====
function exportPDF(){

  const table = document.getElementById("reportTable").cloneNode(true);
  const selectedDate = document.getElementById("reportDate").value || "ทั้งหมด";

  const wrapper = document.createElement("div");

  wrapper.innerHTML = `
    <h2 style="text-align:center;margin-bottom:10px;">
      รายงานการขับขี่ - CPE x Drive Safety
    </h2>
    <p style="text-align:center;margin-bottom:20px;">
      วันที่: ${selectedDate}
    </p>
  `;

  wrapper.appendChild(table);

  const opt = {
    margin: 0.5,
    filename: 'Driving_Report.pdf',
    image: { type: 'jpeg', quality: 0.98 },
    html2canvas: { scale: 2 },
    jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
  };

  html2pdf().set(opt).from(wrapper).save();
}

</script>

</body>
</html>